<%- include('partials/header') %>

<div class="flex h-screen bg-gray-100">
  <%- include('partials/sidebar') %>
  
  <div class="flex-1 overflow-auto">
    <div class="p-6">
      <!-- Header -->
      <div class="mb-6">
        <h1 class="text-2xl font-bold text-gray-900">Quản lý Đánh giá</h1>
        <p class="text-gray-600">Xem và quản lý đánh giá từ khách hàng</p>
      </div>

      <!-- Statistics Cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
              <i class="fas fa-star text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Tổng đánh giá</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.total %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
              <i class="fas fa-clock text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Chờ duyệt</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.pending %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
              <i class="fas fa-check text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Đã duyệt</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.approved %></p>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
              <i class="fas fa-times text-xl"></i>
            </div>
            <div class="ml-4">
              <p class="text-sm font-medium text-gray-600">Đã từ chối</p>
              <p class="text-2xl font-bold text-gray-900"><%= stats.rejected %></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Filter Section -->
      <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
          <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Trạng thái</label>
              <select id="statusFilter" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">Tất cả trạng thái</option>
                <option value="pending">Chờ duyệt</option>
                <option value="approved">Đã duyệt</option>
                <option value="rejected">Đã từ chối</option>
              </select>
            </div>
                         <div>
               <label class="block text-sm font-medium text-gray-700 mb-2">Loại đánh giá</label>
               <select id="typeFilter" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                 <option value="">Tất cả đánh giá</option>
                 <option value="service">Dịch vụ</option>
                 <option value="stylist">Stylist</option>
               </select>
             </div>
          </div>
          <div class="flex space-x-3">
            <button id="clearFilters" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
              <i class="fas fa-times mr-2"></i>Xóa bộ lọc
            </button>
            <button id="refreshData" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
              <i class="fas fa-sync-alt mr-2"></i>Làm mới
            </button>
          </div>
        </div>
      </div>

      <!-- Reviews Table -->
      <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
          <h3 class="text-lg font-semibold text-gray-900">Danh sách đánh giá</h3>
        </div>
        
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Khách hàng</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Đánh giá</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nội dung</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dịch vụ/Sản phẩm</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ngày đánh giá</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trạng thái</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Thao tác</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <% reviews.forEach(function(review) { %>
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    #<%= review.id %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                        <i class="fas fa-user text-gray-600"></i>
                      </div>
                      <div class="ml-4">
                        <div class="text-sm font-medium text-gray-900"><%= review.customer_name %></div>
                        <div class="text-sm text-gray-500"><%= review.customer_email %></div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                      <div class="flex text-yellow-400">
                        <% for(let i = 1; i <= 5; i++) { %>
                          <i class="fas fa-star <%= i <= review.rating ? 'text-yellow-400' : 'text-gray-300' %>"></i>
                        <% } %>
                      </div>
                      <span class="ml-2 text-sm text-gray-600">(<%= review.rating %>/5)</span>
                    </div>
                  </td>
                  <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate" title="<%= review.comment %>">
                      <%= review.comment %>
                    </div>
                  </td>
                                     <td class="px-6 py-4 whitespace-nowrap">
                     <div class="text-sm text-gray-900">
                       <% if (review.service_name) { %>
                         <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                           <i class="fas fa-cut mr-1"></i><%= review.service_name %>
                         </span>
                       <% } else if (review.stylist_name) { %>
                         <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                           <i class="fas fa-user-tie mr-1"></i><%= review.stylist_name %>
                         </span>
                       <% } else { %>
                         <span class="text-gray-500">-</span>
                       <% } %>
                     </div>
                   </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                    <%= new Date(review.created_at).toLocaleDateString('vi-VN') %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                      <% if (review.status === 'pending') { %>bg-yellow-100 text-yellow-800<% } %>
                      <% if (review.status === 'approved') { %>bg-green-100 text-green-800<% } %>
                      <% if (review.status === 'rejected') { %>bg-red-100 text-red-800<% } %>">
                      <% if (review.status === 'pending') { %>
                        <i class="fas fa-clock mr-2"></i>Chờ duyệt
                      <% } %>
                      <% if (review.status === 'approved') { %>
                        <i class="fas fa-check mr-2"></i>Đã duyệt
                      <% } %>
                      <% if (review.status === 'rejected') { %>
                        <i class="fas fa-times mr-2"></i>Đã từ chối
                      <% } %>
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <div class="flex space-x-2">
                      <% if (review.status === 'pending') { %>
                        <button onclick="approveReview(<%= review.id %>)" class="text-green-600 hover:text-green-900" title="Duyệt">
                          <i class="fas fa-check"></i>
                        </button>
                        <button onclick="rejectReview(<%= review.id %>)" class="text-red-600 hover:text-red-900" title="Từ chối">
                          <i class="fas fa-times"></i>
                        </button>
                      <% } %>
                      <button onclick="deleteReview(<%= review.id %>)" class="text-red-600 hover:text-red-900" title="Xóa">
                        <i class="fas fa-trash"></i>
                      </button>
                      <button onclick="viewReview(<%= review.id %>)" class="text-blue-600 hover:text-blue-900" title="Xem chi tiết">
                        <i class="fas fa-eye"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if (totalPages > 1) { %>
          <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
            <div class="flex items-center justify-between">
              <div class="flex-1 flex justify-between sm:hidden">
                <% if (currentPage > 1) { %>
                  <a href="?page=<%= currentPage - 1 %>" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Trước
                  </a>
                <% } %>
                <% if (currentPage < totalPages) { %>
                  <a href="?page=<%= currentPage + 1 %>" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Sau
                  </a>
                <% } %>
              </div>
              <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                  <p class="text-sm text-gray-700">
                    Hiển thị <span class="font-medium"><%= (currentPage - 1) * limit + 1 %></span> đến <span class="font-medium"><%= Math.min(currentPage * limit, totalReviews) %></span> trong tổng số <span class="font-medium"><%= totalReviews %></span> đánh giá
                  </p>
                </div>
                <div>
                  <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                    <% if (currentPage > 1) { %>
                      <a href="?page=<%= currentPage - 1 %>" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-left"></i>
                      </a>
                    <% } %>
                    
                    <% for(let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) { %>
                      <a href="?page=<%= i %>" class="relative inline-flex items-center px-4 py-2 border text-sm font-medium <%= i === currentPage ? 'z-10 bg-blue-50 border-blue-500 text-blue-600' : 'bg-white border-gray-300 text-gray-500 hover:bg-gray-50' %>">
                        <%= i %>
                      </a>
                    <% } %>
                    
                    <% if (currentPage < totalPages) { %>
                      <a href="?page=<%= currentPage + 1 %>" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <i class="fas fa-chevron-right"></i>
                      </a>
                    <% } %>
                  </nav>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
// Filter functionality
document.getElementById('statusFilter').addEventListener('change', function() {
  applyFilters();
});

document.getElementById('typeFilter').addEventListener('change', function() {
  applyFilters();
});

document.getElementById('clearFilters').addEventListener('click', function() {
  document.getElementById('statusFilter').value = '';
  document.getElementById('typeFilter').value = '';
  applyFilters();
});

document.getElementById('refreshData').addEventListener('click', function() {
  location.reload();
});

function applyFilters() {
  const status = document.getElementById('statusFilter').value;
  const type = document.getElementById('typeFilter').value;
  
  let url = '/admin/reviews?';
  if (status) url += `status=${status}&`;
  if (type) url += `type=${type}&`;
  
  window.location.href = url;
}

// Review actions
function approveReview(reviewId) {
  if (confirm('Bạn có chắc chắn muốn duyệt đánh giá này?')) {
    fetch(`/admin/reviews/${reviewId}/approve`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Duyệt đánh giá thành công!');
        location.reload();
      } else {
        alert('Có lỗi xảy ra: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi duyệt đánh giá');
    });
  }
}

function rejectReview(reviewId) {
  if (confirm('Bạn có chắc chắn muốn từ chối đánh giá này?')) {
    fetch(`/admin/reviews/${reviewId}/reject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Từ chối đánh giá thành công!');
        location.reload();
      } else {
        alert('Có lỗi xảy ra: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi từ chối đánh giá');
    });
  }
}

function deleteReview(reviewId) {
  if (confirm('Bạn có chắc chắn muốn xóa đánh giá này?')) {
    fetch(`/admin/reviews/${reviewId}/delete`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Xóa đánh giá thành công!');
        location.reload();
      } else {
        alert('Có lỗi xảy ra: ' + data.message);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Có lỗi xảy ra khi xóa đánh giá');
    });
  }
}

function viewReview(reviewId) {
  // Implement view review detail functionality
  alert('Chức năng xem chi tiết đánh giá sẽ được thêm sau');
}
</script>

<%- include('partials/footer') %> 